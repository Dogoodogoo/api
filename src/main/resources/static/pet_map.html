<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <title>ë„êµ¬ë„êµ¬ : í†µí•© ê³µê°„ ë°ì´í„° ì‹œê°í™”</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ë„¤ì´ë²„ ì§€ë„ í´ëŸ¬ìŠ¤í„°ëŸ¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script type="text/javascript" src="https://navermaps.github.io/maps.js.ncp/docs/js/marker-clusterer.js"></script>
    <style>
        #map { width: 100%; height: calc(100vh - 80px); background-color: #f1f5f9; }
        .info-window { padding: 18px; min-width: 280px; font-size: 13px; line-height: 1.6; }
        .marker-anim { transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); cursor: pointer; }
        .marker-anim:hover { transform: scale(1.4) translateY(-5px); z-index: 1000; }
        .filter-btn.active { background-color: #0f172a; color: white; border-color: #0f172a; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }

        /* í´ëŸ¬ìŠ¤í„° ë§ˆì»¤ ë””ìì¸ */
        .cluster-marker { width: 48px; height: 48px; line-height: 48px; text-align: center; border-radius: 50%; border: 3px solid white; color: white; font-weight: 900; font-size: 14px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); cursor: pointer; transition: transform 0.2s; }
        .cluster-marker:hover { transform: scale(1.15); }

        #progress-container { position: fixed; top: 80px; left: 0; width: 100%; height: 3px; background: transparent; z-index: 100; }
        #progress-bar { width: 0%; height: 100%; background: #4f46e5; transition: width 0.3s; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 h-screen flex flex-col overflow-hidden font-sans">

<nav class="bg-white border-b border-slate-200 p-4 shadow-sm z-10 flex-none h-[80px]">
    <div class="max-w-screen-2xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
        <div class="flex items-center gap-4">
            <div class="p-2.5 bg-indigo-600 rounded-2xl text-white shadow-lg shadow-indigo-100">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                </svg>
            </div>
            <div>
                <h1 class="text-xl font-black text-slate-800 tracking-tight">ë„êµ¬ë„êµ¬ í†µí•© ë§µ</h1>
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Performance Optimized v9.9</p>
            </div>
        </div>

        <div class="flex bg-slate-100 p-1.5 rounded-2xl border border-slate-200 gap-1">
            <button onclick="switchCategory('pet_places')" id="btn-pet_places" class="filter-btn active px-5 py-2 rounded-xl text-xs font-bold transition-all border border-transparent">ğŸ¾ ë°˜ë ¤ê²¬ ì¥ì†Œ</button>
            <button onclick="switchCategory('drinking_fountains')" id="btn-drinking_fountains" class="filter-btn px-5 py-2 rounded-xl text-xs font-bold text-slate-500 hover:bg-white transition-all border border-transparent">ğŸ’§ ìŒìˆ˜ëŒ€</button>
            <button onclick="switchCategory('trash_bins')" id="btn-trash_bins" class="filter-btn px-5 py-2 rounded-xl text-xs font-bold text-slate-500 hover:bg-white transition-all border border-transparent">ğŸ—‘ï¸ ì“°ë ˆê¸°í†µ</button>
        </div>

        <div class="flex items-center gap-4">
            <div id="loading-status" class="hidden flex items-center gap-2 text-[11px] text-indigo-600 font-bold">
                <div class="w-3 h-3 border-2 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
                ë°ì´í„° ë™ê¸°í™”...
            </div>
            <div class="px-4 py-2 bg-slate-900 text-white rounded-2xl font-bold text-xs">í˜„ì¬ ì‹œì•¼: <span id="marker-count">0</span>ê±´</div>
        </div>
    </div>
</nav>

<div id="progress-container"><div id="progress-bar"></div></div>

<main class="flex-1 relative overflow-hidden bg-slate-100">
    <div id="map"></div>
</main>

<script>
    let map;
    let markers = [];
    let clusterer = null;
    let currentCategory = 'pet_places';
    let sharedInfoWindow = null;
    let isAutoFitting = false;
    let loadTimeout = null;

    const BACKEND_BASE_URL = 'http://localhost:8080';
    // [ì„±ëŠ¥ ê°œì„ ] í•œ ë²ˆì— ì²˜ë¦¬í•˜ëŠ” ë§ˆì»¤ ìˆ˜ë¥¼ ì¤„ì—¬ ë Œë”ë§ ë™ì„ ìµœì†Œí™”
    const CHUNK_SIZE = 150;

    const categoryConfig = {
        // [ìˆ˜ì •] ëª¨ë“  ì¹´í…Œê³ ë¦¬ì˜ fetchSizeë¥¼ 500ìœ¼ë¡œ ì—„ê²©íˆ ì œí•œ
        pet_places: { label: 'ë°˜ë ¤ê²¬ ì¥ì†Œ', endpoint: '/api/v1/pet-places', color: 'bg-indigo-600', clusterColor: '#4f46e5', icon: 'ğŸ¾', fetchSize: 500 },
        drinking_fountains: { label: 'ìŒìˆ˜ëŒ€', endpoint: '/api/v1/fountains', color: 'bg-sky-500', clusterColor: '#0ea5e9', icon: 'ğŸ’§', fetchSize: 500 },
        trash_bins: { label: 'ì“°ë ˆê¸°í†µ', endpoint: '/api/v1/trash-bins', color: 'bg-emerald-600', clusterColor: '#059669', icon: 'ğŸ—‘ï¸', fetchSize: 500 }
    };

    function switchCategory(category) {
        if (currentCategory === category) return;
        currentCategory = category;
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active', 'text-slate-500'));
        document.getElementById(`btn-${category}`).classList.add('active');
        loadCurrentCategoryData(true);
    }

    async function loadCurrentCategoryData(shouldFitBounds = false) {
        if (!map) return;

        const loader = document.getElementById('loading-status');
        const progressBar = document.getElementById('progress-bar');

        const bounds = map.getBounds();
        const sw = bounds.getSW();
        const ne = bounds.getNE();
        const center = map.getCenter();

        loader.classList.remove('hidden');
        progressBar.style.width = '0%';

        const conf = categoryConfig[currentCategory];

        const params = new URLSearchParams({
            minLat: sw.lat(),
            maxLat: ne.lat(),
            minLng: sw.lng(),
            maxLng: ne.lng(),
            centerLat: center.lat(),
            centerLng: center.lng(),
            page: 1,
            size: conf.fetchSize // 500ê±´ìœ¼ë¡œ ì œí•œëœ íŒŒë¼ë¯¸í„° ì „ì†¡
        });

        const url = `${BACKEND_BASE_URL}${conf.endpoint}?${params.toString()}`;

        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            let items = data.items || [];

            // [ì¶”ê°€] í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œì—ì„œë„ 500ê±´ì„ ë„˜ì§€ ì•Šë„ë¡ ë³´ì¥
            if (items.length > conf.fetchSize) {
                items = items.slice(0, conf.fetchSize);
            }

            document.getElementById('marker-count').innerText = items.length;
            processMarkersInChunks(items, currentCategory, shouldFitBounds);
        } catch (e) {
            console.error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", e);
            loader.classList.add('hidden');
        }
    }

    function processMarkersInChunks(items, category, shouldFitBounds) {
        if (clusterer) { clusterer.clearMarkers(); clusterer.setMap(null); clusterer = null; }
        markers.forEach(m => m.setMap(null));
        markers = [];
        if (sharedInfoWindow) sharedInfoWindow.close();

        const conf = categoryConfig[category];
        const total = items.length;
        let index = 0;
        const tempBounds = new naver.maps.LatLngBounds();

        if (total === 0) {
            document.getElementById('loading-status').classList.add('hidden');
            document.getElementById('progress-bar').style.width = '0%';
            return;
        }

        function renderChunk() {
            const end = Math.min(index + CHUNK_SIZE, total);
            for (; index < end; index++) {
                const item = items[index];
                if (!item.latitude || !item.longitude || item.latitude === 0) continue;

                const latlng = new naver.maps.LatLng(item.latitude, item.longitude);
                if (shouldFitBounds) tempBounds.extend(latlng);

                const marker = new naver.maps.Marker({
                    position: latlng,
                    map: null,
                    icon: {
                        content: `<div class="marker-anim w-6 h-6 ${conf.color} border-2 border-white rounded-full shadow-lg flex items-center justify-center text-[10px] text-white font-bold">${conf.icon}</div>`,
                        anchor: new naver.maps.Point(12, 12)
                    }
                });

                (function(m, i, c) {
                    naver.maps.Event.addListener(m, "click", () => {
                        const content = generateHtml(i, c, conf);
                        sharedInfoWindow.setContent(content);
                        sharedInfoWindow.open(map, m);
                    });
                })(marker, item, category);

                markers.push(marker);
            }

            document.getElementById('progress-bar').style.width = `${(index / total) * 100}%`;

            if (index < total) {
                setTimeout(renderChunk, 10);
            } else {
                initClustering(conf);
                if (shouldFitBounds && !tempBounds.isEmpty()) {
                    isAutoFitting = true;
                    map.fitBounds(tempBounds);
                    setTimeout(() => { isAutoFitting = false; }, 500);
                }
            }
        }
        renderChunk();
    }

    function generateHtml(item, category, conf) {
        let title = '';
        if (category === 'pet_places') title = item.placeName;
        else if (category === 'drinking_fountains') title = item.fountainName;
        else if (category === 'trash_bins') title = (item.cityName || '') + ' ' + (item.locationDesc || 'ê°€ë¡œíœ´ì§€í†µ');

        return `
            <div class="info-window bg-white shadow-2xl rounded-3xl p-6 border border-slate-50">
                <div class="flex items-center gap-2 mb-2">
                    <span class="text-[9px] font-black ${conf.color} text-white px-2 py-0.5 rounded-lg uppercase tracking-tighter">${conf.label}</span>
                </div>
                <h4 class="font-black text-slate-900 text-base mb-3 leading-tight">${title || 'ì •ë³´ ì—†ìŒ'}</h4>
                <div class="space-y-2 text-[11px] text-slate-500 border-t border-slate-50 pt-3">
                    <p class="flex items-start gap-2"><span class="font-black text-slate-800 min-w-[55px]">ì£¼ì†Œ</span> <span>${item.address || '-'}</span></p>
                    ${category === 'pet_places' ? `<p class="flex items-start gap-2"><span class="font-black text-slate-800 min-w-[55px]">ë™ë°˜ì •ë³´</span> <span class="text-indigo-600 font-bold">${item.petInfo || 'í™•ì¸ í•„ìš”'}</span></p>` : ''}
                    ${category === 'drinking_fountains' ? `<p class="flex items-start gap-2"><span class="font-black text-slate-800 min-w-[55px]">ê´€ë¦¬ì£¼ì²´</span> <span>${item.managedBy || '-'}</span></p>` : ''}
                    ${category === 'trash_bins' ? `<p class="flex items-start gap-2"><span class="font-black text-slate-800 min-w-[55px]">ìˆ˜ê±°ìœ í˜•</span> <span class="text-emerald-600 font-bold">${item.binType || 'ì¼ë°˜'}</span></p>` : ''}
                </div>
            </div>`;
    }

    function initClustering(conf) {
        if (typeof MarkerClustering !== 'undefined' && markers.length > 0) {
            clusterer = new MarkerClustering({
                minClusterSize: 2,
                maxZoom: 15,
                map: map,
                markers: markers,
                disableClickZoom: false,
                gridSize: 120,
                icons: Array(5).fill({ content: `<div class="cluster-marker" style="background:${conf.clusterColor}"></div>` }),
                // [ìˆ˜ì •] 500ê±´ í•œë„ì— ìµœì í™”ëœ ì¸ë±ìŠ¤ ì„¤ì •
                indexGenerator: [10, 50, 100, 250, 500],
                stylingFunction: (clusterMarker, count) => {
                    const el = clusterMarker.getElement();
                    if (el && el.querySelector('.cluster-marker')) el.querySelector('.cluster-marker').innerText = count;
                }
            });
        } else {
            markers.forEach(m => m.setMap(map));
        }

        document.getElementById('loading-status').classList.add('hidden');
        setTimeout(() => { document.getElementById('progress-bar').style.width = '0%'; }, 500);
    }

    (function initMap() {
        const script = document.createElement('script');
        script.src = 'https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=nxnux3f3r1&submodules=geocoder';
        script.onload = () => {
            map = new naver.maps.Map('map', {
                center: new naver.maps.LatLng(37.5172, 127.0473),
                zoom: 14,
                zoomControl: true,
                mapTypeControl: true
            });

            sharedInfoWindow = new naver.maps.InfoWindow({
                borderWidth: 0, backgroundColor: "transparent", disableAnchor: true, pixelOffset: new naver.maps.Point(0, -10)
            });

            naver.maps.Event.addListener(map, 'idle', () => {
                if (!isAutoFitting) {
                    if (loadTimeout) clearTimeout(loadTimeout);
                    loadTimeout = setTimeout(loadCurrentCategoryData, 300);
                }
            });
        };
        document.head.appendChild(script);
    })();
</script>
</body>
</html>